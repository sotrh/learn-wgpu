<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sorting on the GPU | Learn Wgpu</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.5ee25272.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.d81694a8.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/3.df808b41.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.3bcf9714.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/49.2380ad6a.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/33.69756e2c.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/38.e6451d9a.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/1.bce404c0.js"><link rel="prefetch" href="/learn-wgpu/assets/js/10.50b00122.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.46699988.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.96cbda42.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.117ea0b6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.84012918.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.e5ad2bed.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.3eee8c2c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.ac128dcf.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.4437b9e7.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.25d97cc0.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.b0c89c22.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.0ed50162.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.915bb439.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.f4fa1ac9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.58ce503b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.182fab5b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.566fdc67.js"><link rel="prefetch" href="/learn-wgpu/assets/js/27.5f815419.js"><link rel="prefetch" href="/learn-wgpu/assets/js/28.770ecf30.js"><link rel="prefetch" href="/learn-wgpu/assets/js/29.748f2423.js"><link rel="prefetch" href="/learn-wgpu/assets/js/30.804d5f19.js"><link rel="prefetch" href="/learn-wgpu/assets/js/31.833b1df6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/32.c52ff9e1.js"><link rel="prefetch" href="/learn-wgpu/assets/js/34.6a41fafc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/35.7e7eb67d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/36.0eb0be30.js"><link rel="prefetch" href="/learn-wgpu/assets/js/37.2a968e7d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/39.5f2e2473.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.82671db4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/40.69527698.js"><link rel="prefetch" href="/learn-wgpu/assets/js/41.736af88d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/42.64c17ea3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/43.7faf8ff4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/44.5802d23c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/45.0c73ed88.js"><link rel="prefetch" href="/learn-wgpu/assets/js/46.77089de6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/47.8742e2b3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/48.931a9c25.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.d496396f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/50.cb2354a2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/51.f929149f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/52.5e2019ec.js"><link rel="prefetch" href="/learn-wgpu/assets/js/53.c510c555.js"><link rel="prefetch" href="/learn-wgpu/assets/js/54.be7baca5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/55.fc9dba09.js"><link rel="prefetch" href="/learn-wgpu/assets/js/56.60c8905d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/57.0c78a32b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/58.4bddc19f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/59.12de17b1.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.cdb2bd9c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/60.2754ab7f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/61.294d0670.js"><link rel="prefetch" href="/learn-wgpu/assets/js/62.345dde1e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/63.73bd156f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/64.4e3d904a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/65.583b24ff.js"><link rel="prefetch" href="/learn-wgpu/assets/js/66.496c3321.js"><link rel="prefetch" href="/learn-wgpu/assets/js/67.f85fd325.js"><link rel="prefetch" href="/learn-wgpu/assets/js/68.e8b496a4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/69.e363da48.js"><link rel="prefetch" href="/learn-wgpu/assets/js/70.31aa3c2b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/71.b8c16f5d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/72.9dd4f6ca.js"><link rel="prefetch" href="/learn-wgpu/assets/js/73.9562f860.js"><link rel="prefetch" href="/learn-wgpu/assets/js/74.bd3f684c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/75.88c2b802.js"><link rel="prefetch" href="/learn-wgpu/assets/js/76.c3276b32.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.25be6a69.js"><link rel="prefetch" href="/learn-wgpu/assets/js/vendors~docsearch.fae73c51.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.5ee25272.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" aria-current="page" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-surface/" class="sidebar-link">The Surface</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">A Better Camera</a></li><li><a href="/learn-wgpu/intermediate/tutorial13-hdr/" class="sidebar-link">High Dynamic Range Rendering</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Compute Pipelines</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/compute/introduction/" class="sidebar-link">Intro to Compute Pipelines</a></li><li><a href="/learn-wgpu/compute/sorting/" aria-current="page" class="active sidebar-link">Sorting on the GPU</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/compute/sorting/#odd-even-sort-aka-brick-sort" class="sidebar-link">Odd-Even Sort (aka. Brick Sort)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/compute/sorting/#when-do-we-stop-sorting" class="sidebar-link">When do we stop sorting?</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/compute/sorting/#porting-odd-even-sort-to-wgsl" class="sidebar-link">Porting odd-even sort to WGSL</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/compute/sorting/#race-conditions-and-barriers" class="sidebar-link">Race conditions and barriers</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/compute/sorting/#calling-the-shader" class="sidebar-link">Calling the shader</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/compute/sorting/#conclusion" class="sidebar-link">Conclusion</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>News</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sorting-on-the-gpu"><a href="#sorting-on-the-gpu" class="header-anchor">#</a> Sorting on the GPU</h1> <p>Dealing with sorted data make most algorithms easier to work with, so
it makes sense that we would want to be able to sort our GPU data on
the GPU. We have to rethink how we approach sorting as the way we do it
as traditional sorting algorithms aren't designed with parallel computing
power in mind. Fortunately there are some algorithms out there that do
work well with the GPU!</p> <h2 id="odd-even-sort-aka-brick-sort"><a href="#odd-even-sort-aka-brick-sort" class="header-anchor">#</a> Odd-Even Sort (aka. Brick Sort)</h2> <p>This sort works by iterating over pairs of items, comparing them, and
swapping them if one is greater than the other. Consider the following
array:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
</code></pre></div><p>First we do the odd pass. This means that we consider pairs of items from
index 1 (not 0) up. So for the above data, the pairs would be the following.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>We skip the first and last term as those are don't have another number
next to them that isn't already paired up. We then swap the higher number
with the lower number meaning our data looks as follows:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre></div><p>Next is the even pass. This the same as the odd pass, but we start at index
0 instead of 1. This gives us the following pairs.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>Which when swap yields the following:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre></div><p>This process repeats until the array is sorted. Here's the data at each
iteration after this:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment">// odd</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token comment">// even</span>
</code></pre></div><h2 id="when-do-we-stop-sorting"><a href="#when-do-we-stop-sorting" class="header-anchor">#</a> When do we stop sorting?</h2> <p>Most sorting algorithms don't manually check that the array is sorted
after each iteration. Fortunately <a href="https://en.wikipedia.org/wiki/Odd%E2%80%93even_sort#cite_note-6" target="_blank" rel="noopener noreferrer">research shows<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
that the max number of iterations to complete this algorithm is the
same as the number of items, ie N. This means that given an array of
size <code>N = 8</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><p>It will take 8 passes to sort this data.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// odd</span>
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// even</span>
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// odd</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment">// even</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment">// odd</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token comment">// even</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token comment">// odd</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token comment">// even</span>
</code></pre></div><p>This will always work, regardless of the data we are sorting. It's a
little inefficient when your data is almost sorted, so you'll want to
keep that in mind.</p> <h2 id="porting-odd-even-sort-to-wgsl"><a href="#porting-odd-even-sort-to-wgsl" class="header-anchor">#</a> Porting odd-even sort to WGSL</h2> <p>The odd-even sort is special as each pass is trivial to parallelize.
Each pair of items is considered independantly of all the other items.
That means that we can dedicate a single thread to every pair we want
to compare. Let's jump into the shader!</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">storage</span><span class="token punctuation">,</span> read_write<span class="token punctuation">&gt;</span> data<span class="token punctuation">:</span> <span class="token builtin">array</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">compute</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">workgroup_size</span><span class="token punctuation">(</span><span class="token int-literal number">64</span><span class="token punctuation">,</span> <span class="token int-literal number">1</span><span class="token punctuation">,</span> <span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">fn</span> <span class="token functions function">odd_even_sort</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">global_invocation_id</span><span class="token punctuation">)</span></span>
    gid<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This works much the same as with the introduction code. We setup our bindgroup
with one <code>array&lt;u32&gt;</code> that is <code>read_write</code> as this sort works without needing
an additional array to output into. We also only need the <code>global_invocation_id</code>
builtin to properly index our <code>data</code>. No we'll start looking at the code inside
of <code>odd_even_sort</code>.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code>    <span class="token keyword">let</span> num_items <span class="token operator">=</span> <span class="token function-calls function">arrayLength</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pair_index <span class="token operator">=</span> gid<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
</code></pre></div><p>First we get the index of the pair the current thread is working on.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code>    <span class="token comment">// odd</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> pair_index <span class="token operator">*</span> <span class="token int-literal number">2u</span> <span class="token operator">+</span> <span class="token int-literal number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token int-literal number">1u</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> a <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> b <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token punctuation">&gt;</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> temp <span class="token operator">=</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>For this part of the code, first we get the indices of the items we want to compare.
If the indices are in bounds and the values are out of order, swap the values. We can
do the even pass as well so that we can halve the number of times we call this shader.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code>    <span class="token comment">// even</span>
    a <span class="token operator">=</span> pair_index <span class="token operator">*</span> <span class="token int-literal number">2u</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token int-literal number">1u</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> a <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> b <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token punctuation">&gt;</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> temp <span class="token operator">=</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>It seems like we're done with the shader code, but there's technically
an error in our code. It's nothing with the logic of our code, it has
to do with the nature of parallel coding in general: race conditions.</p> <h2 id="race-conditions-and-barriers"><a href="#race-conditions-and-barriers" class="header-anchor">#</a> Race conditions and barriers</h2> <p><img src="/learn-wgpu/assets/img/race-condition-puppies.4a322f6e.jpg" alt="example of race conditions featuring puppies"></p> <p>A race condition occurs when two or more threads try to opperate on the
same location in memory. If we did one step for each call to the shader,
we would be fine, but since we do two passes, we need to make sure that
the threads aren't tripping over each other. We do this using barriers.</p> <p>A barrier causes the current thread to wait for other threads to finish
before continuing. There are two types of barrier.</p> <p>A <code>workgroupBarrier</code> will cause all the threads in the workgroup to wait
until all other threads in the work group have reached the barrier. It
will also sync up all atomic variables and data stored in workgroup address
space as well.</p> <div class="note"><p>In WGSL and &quot;address space&quot; determines how a certain chunk of can be access.
Data in the <code>workgroup</code> address space is only accessible by threads within
the same workgroup. Many of the address spaces are implicit such as the
<code>function</code> address space. The <code>uniform</code> and <code>storage</code> address spaces are
significant as they correspond to uniform buffers and storage buffers
respectively.</p></div> <p>A <code>storageBarrier</code> will cause the GPU to sync all changes to storage buffers.
Since our data is in a storage buffer, this is the barrier we need to
ensure that things stay in sync. Add the following line between the odd and
even passes.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code>    <span class="token builtin">storageBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>With that the <code>odd_even_sort</code> function looks like this:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">compute</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">workgroup_size</span><span class="token punctuation">(</span><span class="token int-literal number">64</span><span class="token punctuation">,</span> <span class="token int-literal number">1</span><span class="token punctuation">,</span> <span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">fn</span> <span class="token functions function">odd_even_sort</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">global_invocation_id</span><span class="token punctuation">)</span></span>
    gid<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> num_items <span class="token operator">=</span> <span class="token function-calls function">arrayLength</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pair_index <span class="token operator">=</span> gid<span class="token punctuation">.</span>x<span class="token punctuation">;</span>

    <span class="token comment">// odd</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> pair_index <span class="token operator">*</span> <span class="token int-literal number">2u</span> <span class="token operator">+</span> <span class="token int-literal number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token int-literal number">1u</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> a <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> b <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token punctuation">&gt;</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> temp <span class="token operator">=</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token builtin">storageBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// even</span>
    a <span class="token operator">=</span> pair_index <span class="token operator">*</span> <span class="token int-literal number">2u</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token int-literal number">1u</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> a <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> b <span class="token punctuation">&lt;</span> num_items <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token punctuation">&gt;</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> temp <span class="token operator">=</span> data<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="calling-the-shader"><a href="#calling-the-shader" class="header-anchor">#</a> Calling the shader</h2> <p>Most of the code is the same as the introduction code, with the
exception of only creating one storage buffer and the following
code to call the shader:</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token keyword">let</span> num_items_per_workgroup <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">// 64 threads, 2 items per thread</span>
    <span class="token keyword">let</span> num_dispatches <span class="token operator">=</span> <span class="token punctuation">(</span>input_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_items_per_workgroup<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span>
        <span class="token operator">+</span> <span class="token punctuation">(</span>input_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> num_items_per_workgroup <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
    <span class="token comment">// We do 2 passes in the shader so we only need to do half the passes</span>
    <span class="token keyword">let</span> num_passes <span class="token operator">=</span> input_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> input_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_compute_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>num_passes <span class="token punctuation">{</span>
            pass<span class="token punctuation">.</span><span class="token function">dispatch_workgroups</span><span class="token punctuation">(</span>num_dispatches<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>With this, your data should be sorted. You can now use it for whatever purpose
you need such as sorting transparent objects by their z coordinate, or sorting
objects by what cell the belong to in a grid for collision detect and resolution.
We'll be using sorting to implement some different algorithms in other parts of
this guide.</p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>Sorting is one of the pillars of software development and now that we can sort
our GPU data without sending it on a round trip to the GPU. We'll be using this
a lot in the rest of this guide.</p> <p>Thanks for reading this, and a special thanks to these patrons!</p> <ul><li>Filip</li> <li>Lions Heart</li> <li>Jani Turkia</li> <li>Julius Liu</li> <li>折登 樹</li> <li>Aron Granberg</li> <li>Ian Gowen</li> <li>Bernard Llanos</li> <li>David Laban</li> <li>IC</li></ul> <div id="wasm-example"><!----> <!----> <!----> <!----> <!----></div> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/compute/src/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/9/2025, 9:03:41 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/compute/introduction/" class="prev">
          Intro to Compute Pipelines
        </a></span> <span class="next"><a href="/learn-wgpu/showcase/">
          Foreword
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.d81694a8.js" defer></script><script src="/learn-wgpu/assets/js/3.df808b41.js" defer></script><script src="/learn-wgpu/assets/js/2.3bcf9714.js" defer></script><script src="/learn-wgpu/assets/js/49.2380ad6a.js" defer></script><script src="/learn-wgpu/assets/js/33.69756e2c.js" defer></script><script src="/learn-wgpu/assets/js/38.e6451d9a.js" defer></script>
  </body>
</html>
