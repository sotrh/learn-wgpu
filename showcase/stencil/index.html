<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Stencil Buffers | Learn Wgpu</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.5ee25272.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.144d80a8.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/3.09b12233.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.b4dddcef.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/47.8c00aa50.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/39.f2a3e671.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/1.3558807b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/10.9ff91bb3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.7d5157d3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.c7a7639b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.a3e6be1f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.9642a599.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.4274372e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.32b4f2ab.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.6f2eb70a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.5bc894ac.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.dfebde97.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.b9e4c382.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.361a186c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.5e701641.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.98113f96.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.4c10a91e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.fbeaf76c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.1b21e37d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/27.ab582c70.js"><link rel="prefetch" href="/learn-wgpu/assets/js/28.d0db7843.js"><link rel="prefetch" href="/learn-wgpu/assets/js/29.394fe4be.js"><link rel="prefetch" href="/learn-wgpu/assets/js/30.7049dcd5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/31.5b1fe4b4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/32.61a0e3df.js"><link rel="prefetch" href="/learn-wgpu/assets/js/33.68ccf322.js"><link rel="prefetch" href="/learn-wgpu/assets/js/34.e12e647a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/35.4a44c032.js"><link rel="prefetch" href="/learn-wgpu/assets/js/36.8dba74db.js"><link rel="prefetch" href="/learn-wgpu/assets/js/37.f9aa3b5e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/38.e4be4aa4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.a61b351a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/40.a367c5f3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/41.412b049e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/42.f357fe57.js"><link rel="prefetch" href="/learn-wgpu/assets/js/43.b38b7739.js"><link rel="prefetch" href="/learn-wgpu/assets/js/44.aaea4c1c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/45.ad4bba54.js"><link rel="prefetch" href="/learn-wgpu/assets/js/46.6114d33c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/48.156c0523.js"><link rel="prefetch" href="/learn-wgpu/assets/js/49.07fe607e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.19ad0b17.js"><link rel="prefetch" href="/learn-wgpu/assets/js/50.376a13bc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/51.263466c2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/52.3920018c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/53.92bf7263.js"><link rel="prefetch" href="/learn-wgpu/assets/js/54.9fddb631.js"><link rel="prefetch" href="/learn-wgpu/assets/js/55.decc4616.js"><link rel="prefetch" href="/learn-wgpu/assets/js/56.f2675bb1.js"><link rel="prefetch" href="/learn-wgpu/assets/js/57.075c5fd3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/58.5afd0458.js"><link rel="prefetch" href="/learn-wgpu/assets/js/59.e7dc9841.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.d179b982.js"><link rel="prefetch" href="/learn-wgpu/assets/js/60.823ff23f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/61.2554209c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/62.fb196d77.js"><link rel="prefetch" href="/learn-wgpu/assets/js/63.2d962976.js"><link rel="prefetch" href="/learn-wgpu/assets/js/64.1145b7aa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/65.b87d6054.js"><link rel="prefetch" href="/learn-wgpu/assets/js/66.d959165d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/67.46855f1c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/68.e03e895c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/69.9a9d764c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/70.1ed92f63.js"><link rel="prefetch" href="/learn-wgpu/assets/js/71.c41dfa6b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/72.38131aff.js"><link rel="prefetch" href="/learn-wgpu/assets/js/73.8f3337b5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/74.5d4d5004.js"><link rel="prefetch" href="/learn-wgpu/assets/js/75.4ba97ced.js"><link rel="prefetch" href="/learn-wgpu/assets/js/76.44e7a167.js"><link rel="prefetch" href="/learn-wgpu/assets/js/77.4c0c0687.js"><link rel="prefetch" href="/learn-wgpu/assets/js/78.a0fe5922.js"><link rel="prefetch" href="/learn-wgpu/assets/js/79.ae0eb4aa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/80.4f929686.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.36fe1add.js"><link rel="prefetch" href="/learn-wgpu/assets/js/vendors~docsearch.d6596893.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.5ee25272.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" aria-current="page" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-surface/" class="sidebar-link">The Surface</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">A Better Camera</a></li><li><a href="/learn-wgpu/intermediate/tutorial13-hdr/" class="sidebar-link">High Dynamic Range Rendering</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Compute Pipelines</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Showcase</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/showcase/" aria-current="page" class="sidebar-link">Foreword</a></li><li><a href="/learn-wgpu/showcase/mipmaps/" class="sidebar-link">Mipmapping</a></li><li><a href="/learn-wgpu/showcase/stencil/" aria-current="page" class="active sidebar-link">Stencil Buffers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#the-effect" class="sidebar-link">The effect</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#what-are-stencil-buffers-and-how-do-they-help" class="sidebar-link">What are stencil buffers and how do they help?</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#drawing-the-stencil" class="sidebar-link">Drawing the stencil</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#drawing-the-unseen" class="sidebar-link">Drawing the unseen</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#completing-the-effect" class="sidebar-link">Completing the effect</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#conclusion" class="sidebar-link">Conclusion</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#thanks-to-these-supporters" class="sidebar-link">Thanks to these supporters!</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/showcase/stencil/#the-code" class="sidebar-link">The Code</a></li></ul></li><li><a href="/learn-wgpu/showcase/windowless/" class="sidebar-link">Wgpu without a window</a></li><li><a href="/learn-wgpu/showcase/gifs/" class="sidebar-link">Creating gifs</a></li><li><a href="/learn-wgpu/showcase/pong/" class="sidebar-link">Pong</a></li><li><a href="/learn-wgpu/showcase/alignment/" class="sidebar-link">Memory Layout in WGSL</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>News</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="stencil-buffers"><a href="#stencil-buffers" class="header-anchor">#</a> Stencil Buffers</h1> <p>One of the lesser known buffer types, but useful for a lot of
different effects. In this showcase we'll be using it to mimic
the &quot;Lens of Truth&quot; effect seen in the Legend of Zelda Ocarina
of Time and Majora's Mask. Let's jump into it!</p> <h2 id="the-effect"><a href="#the-effect" class="header-anchor">#</a> The effect</h2> <p>For those of you who don't know, the Legend of Zelda series has
a reoccurring item in it called the <a href="https://zelda.fandom.com/wiki/Lens_of_Truth" target="_blank" rel="noopener noreferrer">Lens of Truth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
that allows you see objects that are invisible using an overlay
on the screen.</p> <p><img src="/learn-wgpu/assets/img/mm-lens-of-truth.1a80ebd9.jpg" alt="screenshot of Lens of Truth effect from Majora's mask"></p> <p>Basically it's a transparent circle that's overlayed on top of
the scene and objects that are normally invisible show up in
the circle. Not only objects that are only partially in the cirle
get cut so that the hidden objects stay in the circle.</p> <h2 id="what-are-stencil-buffers-and-how-do-they-help"><a href="#what-are-stencil-buffers-and-how-do-they-help" class="header-anchor">#</a> What are stencil buffers and how do they help?</h2> <p>If you've done any arts and crafts you've likely used a stencil
to paint a tricky shape onto a surface. Stencil buffers allow us
to define a shape to use to mask out parts of the scene to draw.
Internally a stencil buffer is an unsigned integer texture that
you can read and/or write values to when you render objects.</p> <p>Here's how we are going to use a stencil buffer to achieve the
Lens of Truth effect:</p> <ol><li>We'll render a texture to the stencil buffer to use later</li> <li>We'll render the visible objects as normal</li> <li>We'll use the stencil buffer to mask out parts of the hidden
objects.</li> <li>Finally we'll render the texture we used as a mask over top
of the scene to complete the effect.</li></ol> <h2 id="drawing-the-stencil"><a href="#drawing-the-stencil" class="header-anchor">#</a> Drawing the stencil</h2> <p>First let's take a look at creating a stencil texture.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> depth_stencil_format <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Depth24PlusStencil8</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> depth_stencil <span class="token operator">=</span> display<span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;depth_stencil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Extent3d</span> <span class="token punctuation">{</span>
        width<span class="token punctuation">:</span> display<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> display<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        depth_or_array_layers<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mip_level_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
    format<span class="token punctuation">:</span> depth_stencil_format<span class="token punctuation">,</span>
    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
    view_formats<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> depth_stencil_view <span class="token operator">=</span> depth_stencil<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You may have noticed that the texture format for the stencil buffer
is <code>wgpu::TextureFormat::Depth24PlusStencil8</code>. This combines a 24-bit
depth texture and an 8-bit stencil texture. That means we have 256
possible values that we can use to mask out our scene. Other than that
everything looks pretty normal.</p> <p>We then create 4 render pipelines. One to render the mask to the stencil
buffer, one to rendering the visible objects, one to render the hidden
objects using a stencil stage, and one to render the texture we used as
a mask to the screen. We'll skip the visible object pipeline as that's
something that we've already covered in the rendering guide. Let's start
with the mask pipeline.</p> <div class="note"><p>I'm leveraging some code shared between multiple showcases, including
a <code>RenderPipelineBuilder</code> to reduce the boilerplate. I won't go into all
the code for that here, but you can check it out in the
<a href="https://github.com/sotrh/learn-wgpu/tree/master/code/showcase/framework" target="_blank" rel="noopener noreferrer">Github Repo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> mask_pipeline_layout <span class="token operator">=</span>
    display
        <span class="token punctuation">.</span>device
        <span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;mask_pipeline_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>mask_bind_group_layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
            immediate_size<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> mask_shader <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;mask.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> mask_pipeline <span class="token operator">=</span> <span class="token namespace">framework<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">vertex_shader</span><span class="token punctuation">(</span>mask_shader<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fragment_shader</span><span class="token punctuation">(</span>mask_shader<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fragment_entry_point</span><span class="token punctuation">(</span><span class="token string">&quot;fs_mask&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">cull_mode</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Face</span><span class="token punctuation">::</span><span class="token class-name">Back</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">depth_stencil</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthStencilState</span> <span class="token punctuation">{</span>
        format<span class="token punctuation">:</span> depth_stencil_format<span class="token punctuation">,</span>
        depth_write_enabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        depth_compare<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CompareFunction</span><span class="token punctuation">::</span><span class="token class-name">Always</span><span class="token punctuation">,</span>
        stencil<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilState</span> <span class="token punctuation">{</span>
            write_mask<span class="token punctuation">:</span> <span class="token number">0xFF</span><span class="token punctuation">,</span>
            read_mask<span class="token punctuation">:</span> <span class="token number">0xFF</span><span class="token punctuation">,</span>
            front<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilFaceState</span> <span class="token punctuation">{</span>
                compare<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CompareFunction</span><span class="token punctuation">::</span><span class="token class-name">Always</span><span class="token punctuation">,</span>
                pass_op<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilOperation</span><span class="token punctuation">::</span><span class="token class-name">Replace</span><span class="token punctuation">,</span>
                <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            back<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilFaceState</span><span class="token punctuation">::</span><span class="token constant">IGNORE</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        bias<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthBiasState</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mask_pipeline_layout<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>display<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><p>Here we specify that we:</p> <ul><li>Want to use a shader called <code>mask.wgsl</code></li> <li>Want to use backface culling</li> <li>Want to disable depth checking and writing</li> <li>Want a stencil stage that
<ul><li>Reads and writes to all 8-bits of the texture</li> <li>Always replaces that value in the stencil buffer with reference
value (we'll talk about that later) for front facing polygons</li> <li>Ignores back facing polygons</li></ul></li> <li>Want to use the <code>mask_pipeline_layout</code></li></ul> <p>Let's take a look at <code>mask.wgsl</code> now:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> uv<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> mask_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> mask_texture<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">vertex_index</span><span class="token punctuation">)</span></span> in_vertex_index<span class="token punctuation">:</span> <span class="token builtin">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    <span class="token comment">// Create fullscreen triangle</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token builtin">f32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>in_vertex_index <span class="token operator">&lt;&lt;</span> <span class="token int-literal number">1u</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token int-literal number">2u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token builtin">f32</span><span class="token punctuation">(</span>in_vertex_index <span class="token operator">&amp;</span> <span class="token int-literal number">2u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> y <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span> <span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_mask</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sample <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>mask_texture<span class="token punctuation">,</span> mask_sampler<span class="token punctuation">,</span> in<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We invert this check so that the mask will render objects in</span>
    <span class="token comment">// the center</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sample<span class="token punctuation">.</span>a <span class="token punctuation">&gt;</span> <span class="token decimal-float-literal number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">discard</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_color</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sample <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>mask_texture<span class="token punctuation">,</span> mask_sampler<span class="token punctuation">,</span> in<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sample<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This shader is very simple. The vertex shader takes in the current
vertex index and draws a triangle that's bigger than the screen to
create a fullscreen image. The mask fragment shader samples a texture
and discards any fragments that are beyond a certain threshold. The
check is opposite what you would think it would be because we want
to render objects where the mask is transparent, not the other way
around. The color fragment shader just draws the texture to the screen.</p> <p>When we go to render we first need to render the stencil mask.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> draw_mask_stencil <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;draw_mask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDepthStencilAttachment</span> <span class="token punctuation">{</span>
            view<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>depth_stencil_view<span class="token punctuation">,</span>
            depth_ops<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            stencil_ops<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        timestamp_writes<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                multiview_mask<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        occlusion_query_set<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    draw_mask_stencil<span class="token punctuation">.</span><span class="token function">set_stencil_reference</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_mask_stencil<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>mask_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_mask_stencil<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>mask_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_mask_stencil<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Most of this is standard rendering code, but two things of note here</p> <ol><li>We tell wgpu to clear the stencil buffer</li> <li>The <code>set_stencil_reference()</code> function tells wgpu what value we want
to write to the stencil buffer when the stencil test passes.</li></ol> <h2 id="drawing-the-unseen"><a href="#drawing-the-unseen" class="header-anchor">#</a> Drawing the unseen</h2> <p>The next thing we will want to do is to draw our objects with
the stencil buffer. First we need to setup the pipeline.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> hidden_pipeline <span class="token operator">=</span> <span class="token namespace">framework<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>model_pipeline_layout<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">vertex_shader</span><span class="token punctuation">(</span>model_shader<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fragment_shader</span><span class="token punctuation">(</span>model_shader<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">cull_mode</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Face</span><span class="token punctuation">::</span><span class="token class-name">Back</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">color_state</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ColorTargetState</span> <span class="token punctuation">{</span>
        format<span class="token punctuation">:</span> display<span class="token punctuation">.</span>config<span class="token punctuation">.</span>format<span class="token punctuation">,</span>
        blend<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        write_mask<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ColorWrites</span><span class="token punctuation">::</span><span class="token constant">ALL</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">depth_stencil</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthStencilState</span> <span class="token punctuation">{</span>
        format<span class="token punctuation">:</span> depth_stencil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        depth_write_enabled<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        depth_compare<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CompareFunction</span><span class="token punctuation">::</span><span class="token class-name">Less</span><span class="token punctuation">,</span>
        stencil<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilState</span> <span class="token punctuation">{</span>
            <span class="token comment">// Read all bits</span>
            read_mask<span class="token punctuation">:</span> <span class="token number">0xFF</span><span class="token punctuation">,</span>
            write_mask<span class="token punctuation">:</span> <span class="token number">0xFF</span><span class="token punctuation">,</span>
            front<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilFaceState</span> <span class="token punctuation">{</span>
                <span class="token comment">// Only draw when stencil reference == what's in the buffer</span>
                compare<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CompareFunction</span><span class="token punctuation">::</span><span class="token class-name">Equal</span><span class="token punctuation">,</span>
                depth_fail_op<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilOperation</span><span class="token punctuation">::</span><span class="token class-name">Keep</span><span class="token punctuation">,</span>
                <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            back<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilFaceState</span><span class="token punctuation">::</span><span class="token constant">IGNORE</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        bias<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthBiasState</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">vertex_buffer_desc</span><span class="token punctuation">(</span><span class="token class-name">ModelVertex</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">vertex_buffer_desc</span><span class="token punctuation">(</span><span class="token class-name">InstanceVertex</span><span class="token punctuation">::</span><span class="token constant">DESC</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>display<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><div class="note"><p>We are skipping over <code>model.wgsl</code> as it's a standard shader that
just renders the objects using normal mapping and diffuse lighting.
The effect we want can use any shading method as long as the stencil
buffer is used properly.</p> <p>You can check out <a href="https://github.com/sotrh/learn-wgpu/tree/master/code/showcase/stencil/src/model.wgsl" target="_blank" rel="noopener noreferrer">the code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
if you are curious.</p></div> <p>We also create another pipeline just like this one to draw the visible
objects. Will skip over that because it's just the same code but we use
<code>wgpu::StencilState::default()</code> as we don't need to refer/update the
stencil buffer.</p> <p>With that in place we can now draw our hidden objects:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> draw_hidden <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;draw_hidden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
            view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>view<span class="token punctuation">,</span>
            resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Load</span><span class="token punctuation">,</span>
                store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            depth_slice<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDepthStencilAttachment</span> <span class="token punctuation">{</span>
            view<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>depth_stencil_view<span class="token punctuation">,</span>
            depth_ops<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Load</span><span class="token punctuation">,</span>
                store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            stencil_ops<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Load</span><span class="token punctuation">,</span>
                store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        occlusion_query_set<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        timestamp_writes<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                multiview_mask<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    draw_hidden<span class="token punctuation">.</span><span class="token function">set_stencil_reference</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_hidden<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>hidden_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_hidden<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_hidden<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> mesh <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>meshes <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>materials<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>material<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            draw_hidden<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>material<span class="token punctuation">.</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            draw_hidden
                <span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            draw_hidden<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            draw_hidden<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span>
                <span class="token number">0</span><span class="token punctuation">..</span>mesh<span class="token punctuation">.</span>num_elements<span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                instance_split<span class="token punctuation">..</span>num_instances<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>I'm using a <code>Model</code> struct based on <a href="/learn-wgpu/beginner/tutorial9-models/">the model rendering tutorial</a>
with some custom drawing code as I have put the visible and hidden
objects in the same instance buffer. Again the exact model rendering
doesn't matter here as long as your pipeline is setup to use the
stencil buffer correctly.</p> <p>You can also use any model you want, but I'm using the rounded cube
from the same demo.</p> <p>The visible objects use similar code so I'll leave that out for
brevity. You can check
<a href="https://github.com/sotrh/learn-wgpu/tree/master/code/showcase/stencil/" target="_blank" rel="noopener noreferrer">the example code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
if your stuck.</p> <h2 id="completing-the-effect"><a href="#completing-the-effect" class="header-anchor">#</a> Completing the effect</h2> <p>The last thing to do is to draw the stencil texture over the
screen to get finish the effect. The code is roughly the same as
drawing the mask to the stencil buffer, but I'll list it here.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> draw_mask_color <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;draw_mask_color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
            view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>view<span class="token punctuation">,</span>
            resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Load</span><span class="token punctuation">,</span>
                store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            depth_slice<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        timestamp_writes<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                multiview_mask<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        occlusion_query_set<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    draw_mask_color<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>mask_color_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_mask_color<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>mask_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    draw_mask_color<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With all that you should get something like this:</p> <p><img src="/learn-wgpu/assets/img/image.2cd17c49.png" alt="a collection of cubes with a stencil over top"></p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>This is only scratching the surface of what you can do with
stencil buffers. Other effects you can create with stencil
buffers are outlines around objects, x-ray vision, and more complex
lighting techniques such as spot lights all use a stencil buffer.</p> <p>I may cover some of these at a later date, but this should
give you all the tools you need to try some of these yourself.</p> <h2 id="thanks-to-these-supporters"><a href="#thanks-to-these-supporters" class="header-anchor">#</a> Thanks to these supporters!</h2> <ul><li>David Laban</li> <li>Bernard Llanos</li> <li>Ian Gowen</li> <li>Aron Granberg</li> <li> </li> <li>Julius Liu</li> <li>Lennart</li> <li>Jani Turkia</li> <li>Feng Liang</li> <li>Lions Heart</li> <li>Paul E Hansen</li> <li>Gunstein Vatnar</li> <li>Nico Arbogast</li> <li>Dude</li> <li>Youngsuk Kim</li> <li>Alexander Kabirov</li> <li>Danny McGee</li> <li>charlesk</li> <li>yutani</li> <li>Filip</li> <li>Eliot Bolduc</li> <li>Ben Anderson</li> <li>Thunk</li> <li>Craft Links</li> <li>Zeh Fernando</li> <li>Ken</li> <li>Ryan</li> <li>IC</li> <li>Felix</li> <li>Tema</li> <li> </li> <li>Andrea Postal</li> <li>Davide Prati</li> <li>dadofboi</li> <li></li></ul> <p>If this helped you out and you want to support checkout
<a href="https://patreon.com/sotrh" target="_blank" rel="noopener noreferrer">my patreon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://ko-fi.com/sotrh" target="_blank" rel="noopener noreferrer">my kofi account<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>!</p> <h2 id="the-code"><a href="#the-code" class="header-anchor">#</a> The Code</h2> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/showcase/stencil/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/10/2026, 10:07:54 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        
        <a href="/learn-wgpu/showcase/mipmaps/" class="prev">
          Mipmapping
        </a></span> <span class="next"><a href="/learn-wgpu/showcase/windowless/">
          Wgpu without a window
        </a>
        
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.144d80a8.js" defer></script><script src="/learn-wgpu/assets/js/3.09b12233.js" defer></script><script src="/learn-wgpu/assets/js/2.b4dddcef.js" defer></script><script src="/learn-wgpu/assets/js/47.8c00aa50.js" defer></script><script src="/learn-wgpu/assets/js/39.f2a3e671.js" defer></script>
  </body>
</html>
